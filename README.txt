*This README.md file was generated on 2022/18/10 by Anders Ogechi Hostrup Daugberg*

------------------------
General Information

### Title:

EPS gene detection and expression pipeline

------------------------
### Pipeline Description

This pipeline requires Prokka .faa/.gff files, binned contigs, MAG statistics (for example glom_bins.tsv) and a list of PSI-BLAST queries. 
From this, a BLAST database is created and a PSI-BLAST search is performed on the database using the PSI-BLAST queries.
Results from the PSI-BLAST search are filtered based on percent identity with the queries and based on proximity with other homolog genes. Minimum amount of genes and essential genes can also be specified in the script.
Filtered PSI-BLAST results are then used as input for an InterProScan annotation. This is done in order to visualise the presence and synteny of EPS genes in different MAGs using the gggenes R package.
A phylogenetic tree is constructed from HQ MAGs using gtdbtk's de_novo_wf command combined with ARB. The .tree file is used in an R-script, which uses the ggtrees R package to visualise the phylogeny of the MAGs encoding different EPS genes.




------------------------
Data & File Overview
------------------------

### File list:
--------------------
**EPS_PIPELINE/data/raw/**

bins/
All bins from the assembled metagenome, binsHQ contains the ones defined by Checkm2 as high quality MAGs.

prokka/
Prokka results for all bins. Each bin has a folder containing several different file formats. In this pipeline, .faa and .gff are the only ones used.
ProkkaHQ contains the folders for the bins determined by Checkm2 to be high quality MAGs.

faa/
.faa files extracted from /prokkaHQ (See prep_commands.sh)

faa_named/
.faa files from /faa folder with bin name in FASTA header (See prep_commands.sh)

gff/
.gff files extracted from /prokkaHQ (See prep_commands.sh)

reduced_gff/
.gff files with their FASTA sequences removed, for easier loading in R (See prep_commands.sh)

queries_psiblast/
FASTA files containing genes from operons responsible for the production of common exopolysaccharides, to be searched against a BLAST database of the WWTP metagenome.

gff.tsv
Tab separated file created from the files in reduced_gff/ by the generate_gff.R script

glom_bins.tsv
Tab separated file created during assembly showing different magstats

magstats.tsv
modified version of glom_bins.tsv showing only taxonomy and bin name

metagenome.fasta
The raw metagenome file containing all contigs. Used for binning.

Query_figur.xlsx
Excel file containing metadata about genes in the exopolysaccharide operon queries


--------------------
**EPS_PIPELINE/data/metatranscriptomics/**

RSEM/*
Results from RSEM mapping of metatranscriptomic data to EPS_PIPELINE/data/metatranscriptomics/combined.ffn, including TPM tables
Also contains the RSEM bash script

combined.ffn
A concatenated file of all Prokka-generated HQ-MAG .ffn files

metadata_R.xlsx
Metadata for all metatranscriptomic samples (PAO, DPAO and full-scale samples, the latter being found in sheet 2)

RSEM_TPM_summarised.tsv
File containing the TPM values from all metatranscriptomic samples, generated by RSEM

relative_abundance_metagenome.tsv
File containing the relative abundances of all HQ-MAGs from Aalborg West WWTP


--------------------
**EPS_PIPELINE/databases/**
BLAST database files created by mkblastdbm command on concatenated .fas file of all .faa files in EPS_PIPELINE/data/raw/faa_named/ (See prep_commands.sh)
For use in PSI_BLAST search.


--------------------
**EPS_PIPELINE/EPS_synthesis_in_AS_bacteria-main**
Downloaded repository from Maaike et al. paper (https://github.com/SorenHeidelbach/EPS_synthesis_in_AS_bacteria)


--------------------
**EPS_PIPELINE/figures**
operon_article/
Figures generated by EPS_PIPELINE/scripts/R/plot_operon.R

trees/
Figures generated by EPS_PIPELINE/scripts/R/HQ_MAG_tree.R

expression/
Figures generated by EPS_PIPELINE/scripts/R/Fullscale_RSEM_plot.R

expression_connection/
Figures generated by EPS_PIPELINE/scripts/R/transcriptomic_connection.R

operon_expression/
Figures generated by EPS_PIPELINE/scripts/R/plot_operon.R with expression = TRUE

upset/
Figures generated by EPS_PIPELINE/scripts/R/upset.Rmd

--------------------
**EPS_PIPELINE/output_proximity_filtration/**
Output from percent identity and proximity filtration on PSI-BLAST search results.

psi_percID_filt/
Folder containing PSI-BLAST results that were not filterd out by the percent identity filtration

psi_proxi_filt/
Folder containing PSI-BLAST results not filtered out by minimum amount of genes & obligatory gene requirements AND percent identity filtration

psi_operon_full/
Folder containing PSI-BLAST results not filtered out by the previous two filtrations AND the proximity filtration.

fasta_output/
Folder containing the FASTA sequences corresponding to the contigs in the psi_operon_full/ .tsv files


--------------------
**EPS_PIPELINE/psiblast_results/**
Folder containing PSI-BLAST results from psiblast.sh


--------------------
**EPS_PIPELINE/interproscan_results**
Contains results from InterProScan.

interproscan_Pfam/
Results from using the results from the proximity/percentage filtration as queries for InterProScan

ips_queries/
Results from using the exopolysaccharide operon genes as queries for InterProScan


--------------------
**EPS_PIPELINE/scripts/R/**

generate_gff.R
Takes all files from reduced_gff/ and concatenates them into a single .tsv file with less columns

generate_magstats.R
Turns glom_bins.tsv into < new .tsv file with only the bin and gtdb_classification columns

proximity_filtration.R
Takes in magstats.tsv, Query_figur.xlsx and gff.tsv and PSI-BLAST results
Filters PSI-BLAST results by percent identity, minimum and essential genes as well as proximity

plot_operon.R
Plots InterProScan and Psiblast results using gggenes to visualise the presence and synteny of exopolysaccharides in bins. 
Has a flag where it shows expression levels instead of InterProScan results.

HQ_MAG_tree.R
Uses phylogenetic tree created by Tree.sh as well as the percID and proxi files from proximity_filtration.R in order to create a phylogenetic tree which shows which phylae contain exoPS operons.

Fullscale_RSEM_plot.R
Uses EPS_PIPELINE/data/metatranscriptomics/RSEM_TPM_summarised and files from EPS_PIPELINE/output_proximity_filtration/psi_proxi_filt/ in order to visualise the
global expression levels of different exoPS operons across the full-scale S2EBPR process

transcriptomic_connections.R
Visualises expression levels on a MAG level across the full-scale S2EBPR process using results from HQ_MAG_tree.R and Fullscale_RSEM_plot.R

abundance.R
File which analyses relative abundance of HQ-MAGs in Aalborg West WWTP, both metatranscriptomic and metagenomic.
Generates EPS_PIPELINE/data/metatranscriptomics/abundance_metaG.rds and EPS_PIPELINE/data/metatranscriptomics/abundance_metaT.rds from 
EPS_PIPELINE/data/metatranscriptomics/relative_abundance_metaTs.txt and EPS_PIPELINE/data/metatranscriptomics/relative_abundance_metagenome.tsv

upset.Rmd
Rmarkdown document which generates an upset plot to visualise the overlap of psiblast hits for all detected exoPS operons. Also calculates how many HQ-MAGs contain at least 1 exoPS operon, and how many queries have hits.


--------------------
**EPS_PIPELINE/scripts/shell/**
prep_commands.sh
Not a script. Contains linux commands which need to be executed before psiblast.sh and Tree.sh can function.
Also contains commands which create a singular table out of RSEM TPM results.

psiblast.sh
Runs a PSI-BLAST search using the files in databases/ as a database and the files in data/raw/queries_psiblast as queries.

Interproscan.sh 
Runs an InterProScan search on the proximity/percent identity filtered fasta files and removes the FASTA sequences from the resulting gff files.

QueriesInterproscan.sh
Runs the same search as Interproscan.sh but on the .faa files in data/raw/queries_psiblast.

Tree.sh
Creates a phylogenetic tree using gtdbtk's de_novo_wf command. Input is binsHQ.


--------------------
**EPS_PIPELINE/tree_results**
Results from Tree.sh as well as .tree file from ARB editing.


--------------------
**temp**
Temporary files


--------------------



